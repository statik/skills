name: Publish Eval Results

on:
  push:
    branches: [main]
    paths:
      - 'skills/**'
      - 'evals/**'
      - 'Justfile'
  workflow_dispatch:

permissions:
  actions: read
  contents: write
  pages: write
  id-token: write

env:
  PYTHONUNBUFFERED: "1"

jobs:
  publish-evals:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: just setup

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Fetch previous logs from gh-pages
        run: |
          mkdir -p evals/logs
          # Check if gh-pages branch exists
          if git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            echo "Fetching previous logs from gh-pages branch..."
            git fetch origin gh-pages
            # Extract logs from gh-pages branch if they exist
            if git show origin/gh-pages:logs 2>/dev/null; then
              git checkout origin/gh-pages -- logs/ 2>/dev/null || true
              if [ -d "logs" ]; then
                mv logs/* evals/logs/ 2>/dev/null || true
                rm -rf logs
              fi
            fi
            echo "Found $(ls -1 evals/logs/*.eval 2>/dev/null | wc -l) previous log files"
          else
            echo "No gh-pages branch yet, starting fresh"
          fi

      - name: Try to download eval artifacts from merged PR
        id: pr-artifacts
        if: github.event_name == 'push'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Checking if this push is from a merged PR..."

          # Find PR associated with this merge commit
          PR_NUMBER=$(gh api "/repos/$GITHUB_REPOSITORY/commits/$GITHUB_SHA/pulls" \
            --jq '.[0].number' 2>/dev/null || echo "")

          if [ -z "$PR_NUMBER" ]; then
            echo "No PR found for commit $GITHUB_SHA, will run evals fresh"
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found merged PR #$PR_NUMBER"

          # Get the PR's head branch to find the workflow run
          PR_BRANCH=$(gh pr view "$PR_NUMBER" --json headRefName --jq '.headRefName')
          echo "PR head branch: $PR_BRANCH"

          # Find the most recent successful run of validate-skills.yml for that branch
          RUN_ID=$(gh run list \
            --workflow validate-skills.yml \
            --branch "$PR_BRANCH" \
            --status completed \
            --limit 5 \
            --json databaseId,conclusion \
            --jq '[.[] | select(.conclusion=="success")] | .[0].databaseId')

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "No successful workflow run found for PR #$PR_NUMBER, will run evals fresh"
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found workflow run: $RUN_ID"

          # Try to download the eval artifacts
          mkdir -p ./pr-eval-artifacts
          if gh run download "$RUN_ID" --name inspect-eval-logs --dir ./pr-eval-artifacts; then
            # Check if we actually got eval log files
            if compgen -G "./pr-eval-artifacts/evals/logs/*.eval" > /dev/null 2>&1; then
              EVAL_COUNT=$(ls -1 ./pr-eval-artifacts/evals/logs/*.eval | wc -l)
              echo "Successfully downloaded $EVAL_COUNT eval log(s) from PR #$PR_NUMBER (run $RUN_ID)"
              cp ./pr-eval-artifacts/evals/logs/*.eval evals/logs/
              echo "found=true" >> "$GITHUB_OUTPUT"
            else
              echo "Artifact downloaded but no .eval files found, will run evals fresh"
              echo "found=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "Failed to download artifacts from run $RUN_ID, will run evals fresh"
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

          rm -rf ./pr-eval-artifacts

      - name: Check API key
        if: steps.pr-artifacts.outputs.found != 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "::error::ANTHROPIC_API_KEY secret is not set. Cannot run evals."
            exit 1
          fi

          echo "ANTHROPIC_API_KEY is set, validating that it works..."

          HTTP_RESPONSE=$(curl -s -w "\n%{http_code}" https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d '{"model":"claude-haiku-4-5-20251001","max_tokens":1,"messages":[{"role":"user","content":"hi"}]}')

          HTTP_BODY=$(echo "$HTTP_RESPONSE" | sed '$d')
          HTTP_STATUS=$(echo "$HTTP_RESPONSE" | tail -1)

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "API key is valid and working."
          elif [ "$HTTP_STATUS" -eq 401 ]; then
            echo "::error::ANTHROPIC_API_KEY is invalid (HTTP 401). Please update the secret."
            exit 1
          elif [ "$HTTP_STATUS" -eq 403 ]; then
            echo "::error::ANTHROPIC_API_KEY is forbidden (HTTP 403). The key may be disabled."
            exit 1
          elif [ "$HTTP_STATUS" -eq 429 ]; then
            ERROR_MSG=$(echo "$HTTP_BODY" | python3 -c "import sys,json; print(json.load(sys.stdin).get('error',{}).get('message','Unknown error'))" 2>/dev/null || echo "Rate limited")
            echo "::error::Anthropic API rate limited or out of credit (HTTP 429): $ERROR_MSG"
            exit 1
          else
            ERROR_MSG=$(echo "$HTTP_BODY" | python3 -c "import sys,json; print(json.load(sys.stdin).get('error',{}).get('message','Unknown error'))" 2>/dev/null || echo "$HTTP_BODY")
            echo "::error::Anthropic API key validation failed (HTTP $HTTP_STATUS): $ERROR_MSG"
            exit 1
          fi

      - name: Run InspectAI evals
        if: steps.pr-artifacts.outputs.found != 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          just test-claude-anthropic ./logs none

      - name: Retain last 100 logs
        working-directory: evals/logs
        run: |
          # Count .eval files
          count=$(ls -1 *.eval 2>/dev/null | wc -l)
          echo "Total log files: $count"

          if [ "$count" -gt 100 ]; then
            # Sort by modification time, keep newest 100
            ls -1t *.eval | tail -n +101 | xargs rm -f
            echo "Pruned to 100 log files"
          fi

      - name: Generate static HTML bundle
        run: |
          cd evals
          uv run inspect view bundle \
            --log-dir ./logs \
            --output-dir ../site \
            --overwrite
          # Disable Jekyll processing
          touch ../site/.nojekyll

      - name: Deploy to gh-pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: site
          clean: true
          clean-exclude: pr-preview
